<!DOCTYPE html>  <html> <head>   <title>md.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="command.html">                 command.coffee               </a>                                           <a class="source" href="md.html">                 md.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               md.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><a href="http://neocotic.com/html.md">html.md</a> <br />
(c) 2013 Alasdair Mercer <br />
Freely distributable under the MIT license. <br />
Based on <a href="http://homepage.mac.com/tjim/">Make.text</a> 1.5 <br />
(c) 2007 Trevor Jim <br />
For all details and documentation: <br />
<a href="http://neocotic.com/html.md">http://neocotic.com/html.md</a></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Private constants</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Default option values.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">DEFAULT_OPTIONS   =</span>
  <span class="nv">absolute: </span><span class="kc">no</span>
  <span class="nv">base: </span>    <span class="k">if</span> <span class="nb">window</span><span class="o">?</span> <span class="k">then</span> <span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">baseURI</span> <span class="k">else</span> <span class="s">&quot;file://</span><span class="si">#{</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="nv">debug: </span>   <span class="kc">no</span>
  <span class="nv">inline: </span>  <span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Save the previous value of the global <code>md</code> variable for <em>noConflict</em> mode.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">PREVIOUS_MD       = </span><span class="nx">@md</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Map of replacement strings for <em>special</em> Markdown characters.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">REPLACEMENTS      =</span>
  <span class="s">&#39;\\\\&#39;</span><span class="o">:</span>              <span class="s">&#39;\\\\&#39;</span>
  <span class="s">&#39;\\[&#39;</span><span class="o">:</span>               <span class="s">&#39;\\[&#39;</span>
  <span class="s">&#39;\\]&#39;</span><span class="o">:</span>               <span class="s">&#39;\\]&#39;</span>
  <span class="s">&#39;&gt;&#39;</span><span class="o">:</span>                 <span class="s">&#39;\\&gt;&#39;</span>
  <span class="s">&#39;_&#39;</span><span class="o">:</span>                 <span class="s">&#39;\\_&#39;</span>
  <span class="s">&#39;\\*&#39;</span><span class="o">:</span>               <span class="s">&#39;\\*&#39;</span>
  <span class="s">&#39;`&#39;</span><span class="o">:</span>                 <span class="s">&#39;\\`&#39;</span>
  <span class="s">&#39;#&#39;</span><span class="o">:</span>                 <span class="s">&#39;\\#&#39;</span>
  <span class="s">&#39;([0-9])\\.(\\s|$)&#39;</span><span class="o">:</span> <span class="s">&#39;$1\\.$2&#39;</span>
  <span class="s">&#39;\u00a9&#39;</span><span class="o">:</span>            <span class="s">&#39;(c)&#39;</span>
  <span class="s">&#39;\u00ae&#39;</span><span class="o">:</span>            <span class="s">&#39;(r)&#39;</span>
  <span class="s">&#39;\u2122&#39;</span><span class="o">:</span>            <span class="s">&#39;(tm)&#39;</span>
  <span class="s">&#39;\u00a0&#39;</span><span class="o">:</span>            <span class="s">&#39; &#39;</span>
  <span class="s">&#39;\u00b7&#39;</span><span class="o">:</span>            <span class="s">&#39;\\*&#39;</span>
  <span class="s">&#39;\u2002&#39;</span><span class="o">:</span>            <span class="s">&#39; &#39;</span>
  <span class="s">&#39;\u2003&#39;</span><span class="o">:</span>            <span class="s">&#39; &#39;</span>
  <span class="s">&#39;\u2009&#39;</span><span class="o">:</span>            <span class="s">&#39; &#39;</span>
  <span class="s">&#39;\u2018&#39;</span><span class="o">:</span>            <span class="s">&#39;\&#39;&#39;</span>
  <span class="s">&#39;\u2019&#39;</span><span class="o">:</span>            <span class="s">&#39;\&#39;&#39;</span>
  <span class="s">&#39;\u201c&#39;</span><span class="o">:</span>            <span class="s">&#39;&quot;&#39;</span>
  <span class="s">&#39;\u201d&#39;</span><span class="o">:</span>            <span class="s">&#39;&quot;&#39;</span>
  <span class="s">&#39;\u2026&#39;</span><span class="o">:</span>            <span class="s">&#39;...&#39;</span>
  <span class="s">&#39;\u2013&#39;</span><span class="o">:</span>            <span class="s">&#39;--&#39;</span>
  <span class="s">&#39;\u2014&#39;</span><span class="o">:</span>            <span class="s">&#39;---&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Regular expression to extract all <code>display</code> and <code>visibility</code> CSS properties from an inline style
attribute.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">R_HIDDEN_STYLES   = </span><span class="sr">/(display|visibility)\s*:\s*[a-z]+/gi</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Regular expression to check for <em>hidden</em> values of CSS properties.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">R_HIDDEN_VALUE    = </span><span class="sr">/(none|hidden)\s*$/i</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Regular expression to identify elements to be generally ignored, along with their children.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">R_IGNORE_CHILDREN = </span><span class="sr">///</span> <span class="sr">^ (</span>
<span class="sr">    APPLET</span>
<span class="sr">  | AREA</span>
<span class="sr">  | AUDIO</span>
<span class="sr">  | BUTTON</span>
<span class="sr">  | CANVAS</span>
<span class="sr">  | DATALIST</span>
<span class="sr">  | EMBED</span>
<span class="sr">  | HEAD</span>
<span class="sr">  | INPUT</span>
<span class="sr">  | MAP</span>
<span class="sr">  | MENU</span>
<span class="sr">  | METER</span>
<span class="sr">  | NOFRAMES</span>
<span class="sr">  | NOSCRIPT</span>
<span class="sr">  | OBJECT</span>
<span class="sr">  | OPTGROUP</span>
<span class="sr">  | OPTION</span>
<span class="sr">  | PARAM</span>
<span class="sr">  | PROGRESS</span>
<span class="sr">  | RP</span>
<span class="sr">  | RT</span>
<span class="sr">  | RUBY</span>
<span class="sr">  | SCRIPT</span>
<span class="sr">  | SELECT</span>
<span class="sr">  | STYLE</span>
<span class="sr">  | TEXTAREA</span>
<span class="sr">  | TITLE</span>
<span class="sr">  | VIDEO</span>
<span class="sr">) $ ///</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Regular expression to identify elements to be parsed as simple paragraphs.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">R_PARAGRAPH_ONLY  = </span><span class="sr">///</span> <span class="sr">^ (</span>
<span class="sr">    ADDRESS</span>
<span class="sr">  | ARTICLE</span>
<span class="sr">  | ASIDE</span>
<span class="sr">  | DIV</span>
<span class="sr">  | FIELDSET</span>
<span class="sr">  | FOOTER</span>
<span class="sr">  | HEADER</span>
<span class="sr">  | NAV</span>
<span class="sr">  | P</span>
<span class="sr">  | SECTION</span>
<span class="sr">) $ ///</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Create a map of regular expressions for all of the <em>special</em> Markdown characters to simplify
access.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">REGEX             = </span><span class="p">(</span>
  <span class="nv">result = </span><span class="p">{}</span>
  <span class="nx">result</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span> <span class="nx">key</span><span class="p">,</span> <span class="s">&#39;g&#39;</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">REPLACEMENTS</span>
  <span class="nx">result</span>
<span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Helper functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Left pad <code>str</code> with the given padding string for the specified number of <code>times</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">padLeft = </span><span class="nf">(str = &#39;&#39;, times = 0, padStr = &#39; &#39;) -&gt;</span>
  <span class="k">return</span> <span class="nx">str</span> <span class="nx">unless</span> <span class="nx">padStr</span>

  <span class="nv">str = </span><span class="nx">padStr</span> <span class="o">+</span> <span class="nx">str</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">times</span><span class="p">]</span>
  <span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Remove whitespace from both ends of <code>str</code>. <br />
This tries to use the native <code>String.prototype.trim</code> function where possible.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">trim = </span><span class="nf">(str = &#39;&#39;) -&gt;</span>
  <span class="k">if</span> <span class="nx">str</span><span class="p">.</span><span class="nx">trim</span> <span class="k">then</span> <span class="nx">str</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="k">else</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/^\s+|\s+$/g</span><span class="p">,</span> <span class="s">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h2>HTML Parser</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Parses HTML code and/or elements into valid Markdown. <br />
Elements are parsed recursively, meaning their children are also parsed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">HtmlParser</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Creates a new <code>HtmlParser</code> for the arguments provided.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@html = &#39;&#39;, @options = {}) -&gt;</span>
    <span class="vi">@atLeft     = @atNoWS = @atP           = </span><span class="kc">yes</span>
    <span class="vi">@buffer     = </span><span class="s">&#39;&#39;</span>
    <span class="vi">@exceptions = </span><span class="p">[]</span>
    <span class="vi">@order      = </span><span class="mi">1</span>
    <span class="vi">@listDepth  = </span><span class="mi">0</span>
    <span class="vi">@inCode     = @inPre  = @inOrderedList = </span><span class="kc">no</span>
    <span class="vi">@last       = </span><span class="kc">null</span>
    <span class="vi">@left       = </span><span class="s">&#39;\n&#39;</span>
    <span class="vi">@links      = </span><span class="p">[]</span>
    <span class="vi">@linkMap    = </span><span class="p">{}</span>
    <span class="vi">@unhandled  = </span><span class="p">{}</span>
    <span class="vi">@options    = </span><span class="p">{}</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@options</span> <span class="o">isnt</span> <span class="s">&#39;object&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Copy all default option values across to <code>options</code> only where they were not specified.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">defaultValue</span> <span class="k">of</span> <span class="nx">DEFAULT_OPTIONS</span>
      <span class="nx">@options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">defaultValue</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;undefined&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Create a DOM if <code>window</code> doesn't exist (i.e. when running in node).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@win = </span><span class="nb">window</span> <span class="o">?</span> <span class="kc">null</span>
    <span class="nx">unless</span> <span class="nx">@win</span><span class="o">?</span>
      <span class="nv">doc  = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;jsdom&#39;</span><span class="p">).</span><span class="nx">jsdom</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nv">features: FetchExternalResources: </span><span class="kc">no</span>
        <span class="nv">url: </span>     <span class="nx">@options</span><span class="p">.</span><span class="nx">base</span>
      <span class="vi">@win = </span><span class="nx">doc</span><span class="p">.</span><span class="nx">createWindow</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Create the Node constants if Node doesn't exist (i.e. when running in IE &lt; 9).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">@win</span><span class="p">.</span><span class="nx">Node</span><span class="o">?</span>
      <span class="vi">@win.Node =</span>
        <span class="nv">ELEMENT_NODE: </span><span class="mi">1</span>
        <span class="nv">TEXT_NODE: </span>   <span class="mi">3</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Append <code>str</code> to the buffer string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">append: </span><span class="nf">(str) -&gt;</span>
    <span class="nx">@buffer</span> <span class="o">+=</span> <span class="nx">@last</span> <span class="k">if</span> <span class="nx">@last</span><span class="o">?</span>
    <span class="vi">@last    = </span><span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Access the value of <code>attribute</code> either directly or using <code>getAttribute</code> if possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">attr: </span><span class="nf">(ele, attribute, direct = yes) -&gt;</span>
    <span class="nv">value = </span><span class="k">if</span> <span class="nx">direct</span> <span class="o">or</span> <span class="k">typeof</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">getAttribute</span> <span class="o">isnt</span> <span class="s">&#39;function&#39;</span>
      <span class="nx">ele</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nx">ele</span><span class="p">.</span><span class="nx">getAttribute</span> <span class="nx">attribute</span>

    <span class="nx">value</span> <span class="o">?</span> <span class="s">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Append a Markdown line break to the buffer string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">br: </span><span class="o">-&gt;</span>
    <span class="nx">@append</span> <span class="s">&quot;  </span><span class="si">#{</span><span class="nx">@left</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="vi">@atLeft = @atNoWS = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Prepare the parser for a <code>code</code> element.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">code: </span><span class="o">-&gt;</span>
    <span class="nv">old     = </span><span class="nx">@inCode</span>
    <span class="vi">@inCode = </span><span class="kc">yes</span>

    <span class="o">=&gt;</span> <span class="vi">@inCode = </span><span class="nx">old</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Determine whether the specified element  has the <code>attribute</code> provided either directory or using
<code>hasAttribute</code> if possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">has: </span><span class="nf">(ele, attribute, direct = yes) -&gt;</span>
    <span class="k">if</span> <span class="nx">direct</span> <span class="o">or</span> <span class="k">typeof</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="o">isnt</span> <span class="s">&#39;function&#39;</span>
      <span class="nx">ele</span><span class="p">.</span><span class="nx">hasOwnProperty</span> <span class="nx">attribute</span>
    <span class="k">else</span>
      <span class="nx">ele</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="nx">attribute</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Replace any special characters that can cause problems within code sections.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">inCodeProcess: </span><span class="nf">(str) -&gt;</span>
    <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/`/g</span><span class="p">,</span> <span class="s">&#39;\\`&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Determine whether or not the specified element is visible based on its CSS style.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isVisible: </span><span class="nf">(ele) -&gt;</span>
    <span class="nv">style      = </span><span class="nx">@attr</span> <span class="nx">ele</span><span class="p">,</span> <span class="s">&#39;style&#39;</span><span class="p">,</span> <span class="kc">no</span>
    <span class="nv">properties = </span><span class="nx">style</span><span class="o">?</span><span class="p">.</span><span class="nx">match</span><span class="o">?</span> <span class="nx">R_HIDDEN_STYLES</span>
    <span class="nv">visible    = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Test all relevant CSS properties for possible hiding behaviours.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">properties</span><span class="o">?</span>
      <span class="nv">visible = </span><span class="o">not</span> <span class="nx">R_HIDDEN_VALUE</span><span class="p">.</span><span class="nx">test</span> <span class="nx">property</span> <span class="k">for</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">properties</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Attempt to derive elements visibility based on its computed CSS style where appropriate.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">visible</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">@win</span><span class="p">.</span><span class="nx">getComputedStyle</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>
      <span class="k">try</span>
        <span class="nv">style = </span><span class="nx">@win</span><span class="p">.</span><span class="nx">getComputedStyle</span> <span class="nx">ele</span><span class="p">,</span> <span class="kc">null</span>

        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">style</span><span class="o">?</span><span class="p">.</span><span class="nx">getPropertyValue</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>
          <span class="nv">display    = </span><span class="nx">style</span><span class="p">.</span><span class="nx">getPropertyValue</span> <span class="s">&#39;display&#39;</span>
          <span class="nv">visibility = </span><span class="nx">style</span><span class="p">.</span><span class="nx">getPropertyValue</span> <span class="s">&#39;visibility&#39;</span>
          <span class="nv">visible    = </span><span class="nx">display</span> <span class="o">isnt</span> <span class="s">&#39;none&#39;</span> <span class="o">and</span> <span class="nx">visibility</span> <span class="o">isnt</span> <span class="s">&#39;hidden&#39;</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="nx">@thrown</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#39;getComputedStyle&#39;</span>

    <span class="nx">visible</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Append a Markdown list item based on the context of the current list.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">li: </span><span class="o">-&gt;</span>
    <span class="nv">str = </span><span class="k">if</span> <span class="nx">@inOrderedList</span> <span class="k">then</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@order</span><span class="o">++</span><span class="si">}</span><span class="s">. &quot;</span> <span class="k">else</span> <span class="s">&#39;* &#39;</span>
    <span class="nv">str = </span><span class="nx">padLeft</span> <span class="nx">str</span><span class="p">,</span> <span class="p">(</span><span class="nx">@listDepth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="nx">@append</span> <span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Replace any special characters that can cause problems in normal Markdown blocks.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">nonPreProcess: </span><span class="nf">(str) -&gt;</span>
    <span class="nv">str = </span><span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\n([ \t]*\n)+/g</span><span class="p">,</span> <span class="s">&#39;\n&#39;</span>
    <span class="nv">str = </span><span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\n[ \t]+/g</span><span class="p">,</span>      <span class="s">&#39;\n&#39;</span>
    <span class="nv">str = </span><span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/[ \t]+/g</span><span class="p">,</span>        <span class="s">&#39; &#39;</span>
    <span class="nv">str = </span><span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">REGEX</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">REPLACEMENTS</span>
    <span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Prepare the parser for an <code>ol</code> element.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ol: </span><span class="o">-&gt;</span>
    <span class="nx">do</span> <span class="nx">@p</span> <span class="k">if</span> <span class="nx">@listDepth</span> <span class="o">is</span> <span class="mi">0</span>

    <span class="nv">inOrderedList  = </span><span class="nx">@inOrderedList</span>
    <span class="nv">order          = </span><span class="nx">@order</span>
    <span class="vi">@inOrderedList = </span><span class="kc">yes</span>
    <span class="vi">@order         = </span><span class="mi">1</span>
    <span class="nx">@listDepth</span><span class="o">++</span>

    <span class="o">=&gt;</span>
      <span class="vi">@inOrderedList = </span><span class="nx">inOrderedList</span>
      <span class="vi">@order         = </span><span class="nx">order</span>
      <span class="nx">@listDepth</span><span class="o">--</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Append <code>str</code> to the buffer string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">output: </span><span class="nf">(str) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Strip leading whitespace when code blocks accordingly.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">@inPre</span>
      <span class="nv">str = </span><span class="k">if</span> <span class="nx">@atNoWS</span>
        <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/^[ \t\n]+/</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="sr">/^[ \t]*\n/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">str</span>
        <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/^[ \t\n]+/</span><span class="p">,</span> <span class="s">&#39;\n&#39;</span>
      <span class="k">else</span>
        <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/^[ \t]+/</span><span class="p">,</span> <span class="s">&#39; &#39;</span>

    <span class="k">return</span> <span class="k">if</span> <span class="nx">str</span> <span class="o">is</span> <span class="s">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Ensure this parser is in the correct context.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@atP    = </span><span class="sr">/\n\n$/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">str</span>
    <span class="vi">@atLeft = </span><span class="sr">/\n$/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">str</span>
    <span class="vi">@atNoWS = </span><span class="sr">/[ \t\n]$/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">str</span>
    <span class="nx">@append</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\n/g</span><span class="p">,</span> <span class="nx">@left</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Create a function that can be called later to append <code>str</code> to the buffer string while keeping
the parser in context. <br />
This function is just a lazy shorthand.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">outputLater: </span><span class="nf">(str) -&gt;</span>
    <span class="o">=&gt;</span> <span class="nx">@output</span> <span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Append a Markdown paragraph section to the buffer string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">p: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@atP</span>

    <span class="nx">unless</span> <span class="nx">@atLeft</span>
      <span class="nx">@append</span> <span class="nx">@left</span>
      <span class="vi">@atLeft = </span><span class="kc">yes</span>

    <span class="nx">@append</span> <span class="nx">@left</span>
    <span class="vi">@atNoWS = @atP = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Parse the configured HTML into valid Markdown.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">parse: </span><span class="o">-&gt;</span>
    <span class="vi">@buffer = </span><span class="s">&#39;&#39;</span>

    <span class="k">return</span> <span class="nx">@buffer</span> <span class="nx">unless</span> <span class="nx">@html</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Create a wrapper element to insert the configured HTML into.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">container = </span><span class="nx">@win</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s">&#39;div&#39;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@html</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span>
      <span class="nv">container.innerHTML = </span><span class="nx">@html</span>
    <span class="k">else</span>
      <span class="nx">container</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">@html</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Process the contents (i.e. the preconfigured HTML) of the wrapper element.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@process</span> <span class="nx">container</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Ensure all link references are correctly appended to be end of the buffer string.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@links</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">@append</span> <span class="s">&#39;\n\n&#39;</span>
      <span class="nx">@append</span> <span class="s">&quot;[</span><span class="si">#{</span><span class="nx">i</span><span class="si">}</span><span class="s">]: </span><span class="si">#{</span><span class="nx">link</span><span class="si">}</span><span class="s">\n&quot;</span> <span class="k">for</span> <span class="nx">link</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@links</span> <span class="k">when</span> <span class="nx">link</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>This isn't nice and I wouldn't really recommend users use this option but, when <code>debug</code> is
enabled, output all debug information either to the console (e.g. <code>stdout</code> in node).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>List any tags that were ignored during processing.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">unhandledTags = </span><span class="p">(</span><span class="nx">tag</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">tag</span> <span class="k">of</span> <span class="nx">@unhandled</span><span class="p">).</span><span class="nx">sort</span><span class="p">()</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="k">if</span> <span class="nx">unhandledTags</span><span class="p">.</span><span class="nx">length</span>
        <span class="s">&quot;&quot;&quot;</span>
<span class="s">          Ignored tags;</span>
<span class="s">          </span><span class="si">#{</span><span class="nx">unhandledTags</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;, &#39;</span><span class="si">}</span><span class="s"></span>
<span class="s">        &quot;&quot;&quot;</span>
      <span class="k">else</span>
        <span class="s">&#39;No tags were ignored&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>List any exceptions that were caught (and swallowed) during processing.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="k">if</span> <span class="nx">@exceptions</span><span class="p">.</span><span class="nx">length</span>
        <span class="s">&quot;&quot;&quot;</span>
<span class="s">          Exceptions;</span>
<span class="s">          </span><span class="si">#{</span><span class="nx">@exceptions</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;\n&#39;</span><span class="si">}</span><span class="s"></span>
<span class="s">        &quot;&quot;&quot;</span>
      <span class="k">else</span>
        <span class="s">&#39;No exceptions were thrown&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>End the buffer string cleanly and we're done!</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@append</span> <span class="s">&#39;&#39;</span>
    <span class="vi">@buffer = </span><span class="nx">trim</span> <span class="nx">@buffer</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Prepare the parser for a <code>pre</code> element.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pre: </span><span class="o">-&gt;</span>
    <span class="nv">old    = </span><span class="nx">@inPre</span>
    <span class="vi">@inPre = </span><span class="kc">yes</span>

    <span class="o">=&gt;</span> <span class="vi">@inPre = </span><span class="nx">old</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Parse the specified element and append the generated Markdown to the buffer string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">process: </span><span class="nf">(ele) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Only <em>visible</em> elements are processed. Doing our best to identify those that are hidden.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@isVisible</span> <span class="nx">ele</span>

    <span class="k">if</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">is</span> <span class="nx">@win</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">ELEMENT_NODE</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Handle typical node elements (e.g. <code>&lt;span&gt;foo bar&lt;/span&gt;</code>).</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">skipChildren = </span><span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Determine the best way (if any) to handle <code>ele</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">try</span>
        <span class="k">if</span> <span class="nx">R_IGNORE_CHILDREN</span><span class="p">.</span><span class="nx">test</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">tagName</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Don't process the element or any of its children.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">skipChildren = </span><span class="kc">yes</span>
        <span class="k">else</span> <span class="k">if</span> <span class="sr">/^H[1-6]$/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">tagName</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Convert HTML headers (e.g. <code>h3</code>) to their Markdown equivalents (e.g. <code>###</code>).</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">level = </span><span class="nb">parseInt</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/([1-6])$/</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

          <span class="nx">do</span> <span class="nx">@p</span>
          <span class="nx">@output</span> <span class="s">&quot;</span><span class="si">#{</span><span class="p">(</span><span class="s">&#39;#&#39;</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">level</span><span class="p">]).</span><span class="nx">join</span> <span class="s">&#39;&#39;</span><span class="si">}</span><span class="s"> &quot;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">R_PARAGRAPH_ONLY</span><span class="p">.</span><span class="nx">test</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">tagName</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Paragraphs are easy as Pi.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">do</span> <span class="nx">@p</span>
        <span class="k">else</span>
          <span class="k">switch</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">tagName</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Ignore the element, but we still want to process their children (obviously).</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;BODY&#39;</span><span class="p">,</span> <span class="s">&#39;FORM&#39;</span> <span class="k">then</span> <span class="k">break</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Can be a simple paragraph but, if <code>ele</code> doesn't have an <code>open</code> attribute specified,
we don't want to process anything other than the first nested <code>summary</code> element.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;DETAILS&#39;</span>
              <span class="nx">do</span> <span class="nx">@p</span>

              <span class="nx">unless</span> <span class="nx">@has</span> <span class="nx">ele</span><span class="p">,</span> <span class="s">&#39;open&#39;</span><span class="p">,</span> <span class="kc">no</span>
                <span class="nv">skipChildren = </span><span class="kc">yes</span>
                <span class="nv">summary      = </span><span class="nx">ele</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s">&#39;summary&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nx">@process</span> <span class="nx">summary</span> <span class="k">if</span> <span class="nx">summary</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Easiest of the bunch... just a Markdown line break.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;BR&#39;</span> <span class="k">then</span> <span class="nx">do</span> <span class="nx">@br</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Insert a horizontal ruler padded on before and after.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;HR&#39;</span>
              <span class="nx">do</span> <span class="nx">@p</span>
              <span class="nx">@output</span> <span class="s">&#39;---&#39;</span>
              <span class="nx">do</span> <span class="nx">@p</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Any element that is commonly displayed in italics as well as <code>U</code> (i.e. underline)
since vanilla Markdown does not support this but the site did try to highlight the
contents.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;CITE&#39;</span><span class="p">,</span> <span class="s">&#39;DFN&#39;</span><span class="p">,</span> <span class="s">&#39;EM&#39;</span><span class="p">,</span> <span class="s">&#39;I&#39;</span><span class="p">,</span> <span class="s">&#39;U&#39;</span><span class="p">,</span> <span class="s">&#39;VAR&#39;</span>
              <span class="nx">@output</span> <span class="s">&#39;_&#39;</span>
              <span class="vi">@atNoWS = </span><span class="kc">yes</span>
              <span class="nv">after   = </span><span class="nx">@outputLater</span> <span class="s">&#39;_&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Any element that is commonly display in bold.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;DT&#39;</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;STRONG&#39;</span>
              <span class="nx">do</span> <span class="nx">@p</span> <span class="k">if</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">is</span> <span class="s">&#39;DT&#39;</span>

              <span class="nx">@output</span> <span class="s">&#39;**&#39;</span>
              <span class="vi">@atNoWS = </span><span class="kc">yes</span>
              <span class="nv">after   = </span><span class="nx">@outputLater</span> <span class="s">&#39;**&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Uncommon element but just wrap its contens in quotation marks. Job done!</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;Q&#39;</span>
              <span class="nx">@output</span> <span class="s">&#39;&quot;&#39;</span>
              <span class="vi">@atNoWS = </span><span class="kc">yes</span>
              <span class="nv">after   = </span><span class="nx">@outputLater</span> <span class="s">&#39;&quot;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Lists need their items to be displayed correctly depending on their type while also
ensuring nested lists are indented properly.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;OL&#39;</span><span class="p">,</span> <span class="s">&#39;UL&#39;</span>
              <span class="nv">after = </span><span class="k">if</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">is</span> <span class="s">&#39;OL&#39;</span> <span class="k">then</span> <span class="nx">do</span> <span class="nx">@ol</span> <span class="k">else</span> <span class="nx">do</span> <span class="nx">@ul</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>List items are displayed differently depending on what kind of list they're parent
is (i.e. ordered or unordered).</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;LI&#39;</span>
              <span class="nx">@replaceLeft</span> <span class="s">&#39;\n&#39;</span>
              <span class="nx">do</span> <span class="nx">@li</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>A pre-formatted element just needs to have its contents properly indented.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;PRE&#39;</span>
              <span class="nv">after1 = </span><span class="nx">@pushLeft</span> <span class="s">&#39;    &#39;</span>
              <span class="nv">after2 = </span><span class="nx">do</span> <span class="nx">@pre</span>

              <span class="nv">after  = </span><span class="o">-&gt;</span>
                <span class="nx">do</span> <span class="nx">after1</span>
                <span class="nx">do</span> <span class="nx">after2</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Inline code elements translate pretty easily but we need to make sure we don't do
anything dumb inside a <code>pre</code> element.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;CODE&#39;</span><span class="p">,</span> <span class="s">&#39;KBD&#39;</span><span class="p">,</span> <span class="s">&#39;SAMP&#39;</span>
              <span class="k">break</span> <span class="k">if</span> <span class="nx">@inPre</span>

              <span class="nx">@output</span> <span class="s">&#39;`&#39;</span>

              <span class="nv">after1 = </span><span class="nx">do</span> <span class="nx">@code</span>
              <span class="nv">after2 = </span><span class="nx">@outputLater</span> <span class="s">&#39;`&#39;</span>

              <span class="nv">after  = </span><span class="o">-&gt;</span>
                <span class="nx">do</span> <span class="nx">after1</span>
                <span class="nx">do</span> <span class="nx">after2</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Block quotes (and similar elements) are relatively straight forward.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;BLOCKQUOTE&#39;</span><span class="p">,</span> <span class="s">&#39;DD&#39;</span> <span class="k">then</span> <span class="nv">after = </span><span class="nx">@pushLeft</span> <span class="s">&#39;&gt; &#39;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Links on the other hand are probably the trickiest.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;A&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Extract the link URL from <code>ele</code>. <br />
Links with no URLs are treated just like text-containing elements (e.g. <code>span</code>). <br />
<code>a.href</code> always returns an absolute URL while <code>a.getAttribute('href')</code> always
returns the exact value of the <code>href</code> attribute. For this reason we need to be sure
that we extract the URL correctly based on the state of the <code>absolute</code> option.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nv">href = </span><span class="nx">@attr</span> <span class="nx">ele</span><span class="p">,</span> <span class="s">&#39;href&#39;</span><span class="p">,</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">absolute</span>
              <span class="k">break</span> <span class="nx">unless</span> <span class="nx">href</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Be sure to include the title after each link reference that will be displayed at
the end of the Markdown output, where possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nv">title  = </span><span class="nx">@attr</span> <span class="nx">ele</span><span class="p">,</span> <span class="s">&#39;title&#39;</span>
              <span class="nx">href</span>  <span class="o">+=</span> <span class="s">&quot; \&quot;</span><span class="si">#{</span><span class="nx">title</span><span class="si">}</span><span class="s">\&quot;&quot;</span> <span class="k">if</span> <span class="nx">title</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Determine what style the link should be generated in (i.e. <em>inline</em> or
<em>reference</em>) depending on the state of the <code>inline</code> option.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nv">suffix = </span><span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">inline</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p><em>Inline</em> style means all links have their URLs (and possible titles) included
immediately after their contents (e.g.
<code>[my link](/path/to/page.html "My title")</code>).</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="s">&quot;(</span><span class="si">#{</span><span class="nx">href</span><span class="si">}</span><span class="s">)&quot;</span>
              <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p><em>Reference</em> style means all links have an index included immediately after their
contents that directly maps to their URL (and possible title) which are displayed
at the end of the buffer string (e.g. <code>[my link][0]</code> and then later
<code>[0]: /path/to/page.html "My title"</code>). <br />
Duplicate link/title combination references are avoided for a cleaner result.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="s">&quot;[</span><span class="si">#{</span><span class="nx">@linkMap</span><span class="p">[</span><span class="nx">href</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">@links</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">href</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s">]&quot;</span>

              <span class="nx">@output</span> <span class="s">&#39;[&#39;</span>
              <span class="vi">@atNoWS = </span><span class="kc">yes</span>
              <span class="nv">after   = </span><span class="nx">@outputLater</span> <span class="s">&quot;]</span><span class="si">#{</span><span class="nx">suffix</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Images are very similar to links, just without the added complexity of references.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;IMG&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Extract the image URL from <code>ele</code>. <br />
Unlike links, any image without a URL is just ignored. Obviously, any contents of
an <code>img</code> element are always ignored since they can never contain anything valid. <br />
<code>img.src</code> always returns an absolute URL while <code>img.getAttribute('src')</code> always
returns the exact value of the <code>src</code> attribute. For this reason we need to be sure
that we extract the URL correctly based on the state of the <code>absolute</code> option.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nv">skipChildren = </span><span class="kc">yes</span>
              <span class="nv">src          = </span><span class="nx">@attr</span> <span class="nx">ele</span><span class="p">,</span> <span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">absolute</span>
              <span class="k">break</span> <span class="nx">unless</span> <span class="nx">src</span>

              <span class="nx">@output</span> <span class="s">&quot;![</span><span class="si">#{</span><span class="nx">@attr</span> <span class="nx">ele</span><span class="p">,</span> <span class="s">&#39;alt&#39;</span><span class="si">}</span><span class="s">](</span><span class="si">#{</span><span class="nx">src</span><span class="si">}</span><span class="s">)&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Frames are <strong>HELL</strong> (fact!), but we'll do our best to support their contents.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;FRAME&#39;</span><span class="p">,</span> <span class="s">&#39;IFRAME&#39;</span>
              <span class="nv">skipChildren = </span><span class="kc">yes</span>

              <span class="k">try</span>
                <span class="k">if</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">contentDocument</span><span class="o">?</span><span class="p">.</span><span class="nx">documentElement</span>
                  <span class="nx">@process</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">contentDocument</span><span class="p">.</span><span class="nx">documentElement</span>
              <span class="k">catch</span> <span class="nx">err</span>
                <span class="nx">@thrown</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#39;contentDocument&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Table rows should just be separated, that's all.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">when</span> <span class="s">&#39;TR&#39;</span> <span class="k">then</span> <span class="nv">after = </span><span class="nx">@p</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Couldn't find a suitable match for <code>ele</code> so let's ignore it, but we'll still process
any children it has.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">else</span>
              <span class="nx">@unhandled</span><span class="p">[</span><span class="nx">ele</span><span class="p">.</span><span class="nx">tagName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">debug</span>
      <span class="k">catch</span> <span class="nx">err</span>
        <span class="nx">@thrown</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">tagName</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Process all child elements of <code>ele</code> if it has any and we've not been told to ignore them.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@process</span> <span class="nx">childNode</span> <span class="k">for</span> <span class="nx">childNode</span> <span class="k">in</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">childNodes</span> <span class="nx">unless</span> <span class="nx">skipChildren</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Ensure any callback are invoked being proceeding <strong>if</strong> they are specified.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">after</span><span class="o">?</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">is</span> <span class="nx">@win</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">TEXT_NODE</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Handle simple text nodes (e.g. <code>"foo bar"</code>) according to the current context.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@output</span> <span class="k">if</span> <span class="nx">@inPre</span>
        <span class="nx">ele</span><span class="p">.</span><span class="nx">nodeValue</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">@inCode</span>
        <span class="nx">@inCodeProcess</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">nodeValue</span>
      <span class="k">else</span>
        <span class="nx">@nonPreProcess</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">nodeValue</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Attach <code>str</code> to the start of the current line.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pushLeft: </span><span class="nf">(str) -&gt;</span>
    <span class="nv">old    = </span><span class="nx">@left</span>
    <span class="nx">@left</span> <span class="o">+=</span> <span class="nx">str</span>

    <span class="k">if</span> <span class="nx">@atP</span> <span class="k">then</span> <span class="nx">@append</span> <span class="nx">str</span> <span class="k">else</span> <span class="nx">do</span> <span class="nx">@p</span>

    <span class="o">=&gt;</span>
      <span class="vi">@left   = </span><span class="nx">old</span>
      <span class="vi">@atLeft = @atP = </span><span class="kc">no</span>

      <span class="nx">do</span> <span class="nx">@p</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Replace the left indent with <code>str</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">replaceLeft: </span><span class="nf">(str) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">@atLeft</span>
      <span class="nx">@append</span> <span class="nx">@left</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/[ ]{2,4}$/</span><span class="p">,</span> <span class="nx">str</span>

      <span class="vi">@atLeft = @atNoWS = @atP = </span><span class="kc">yes</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@last</span>
      <span class="vi">@last   = </span><span class="nx">@last</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/[ ]{2,4}$/</span><span class="p">,</span> <span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Ensure that the <code>exception</code> and the corresponding <code>message</code> is logged if the <code>debug</code> option is
enabled.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">thrown: </span><span class="nf">(exception, message) -&gt;</span>
    <span class="nx">@exceptions</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">message</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">exception</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Prepare the parser for a <code>ul</code> element.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ul: </span><span class="o">-&gt;</span>
    <span class="nx">do</span> <span class="nx">@p</span> <span class="k">if</span> <span class="nx">@listDepth</span> <span class="o">is</span> <span class="mi">0</span>

    <span class="nv">inOrderedList  = </span><span class="nx">@inOrderedList</span>
    <span class="nv">order          = </span><span class="nx">@order</span>
    <span class="vi">@inOrderedList = </span><span class="kc">no</span>
    <span class="vi">@order         = </span><span class="mi">1</span>
    <span class="nx">@listDepth</span><span class="o">++</span>

    <span class="o">=&gt;</span>
      <span class="vi">@inOrderedList = </span><span class="nx">inOrderedList</span>
      <span class="vi">@order         = </span><span class="nx">order</span>
      <span class="nx">@listDepth</span><span class="o">--</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <h2>html.md setup</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Build the publicly exposed API.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@md = </span><span class="nv">md = </span><span class="nf">(html, options) -&gt;</span>
  <span class="k">new</span> <span class="nx">HtmlParser</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">parse</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Export <code>md</code> for NodeJS and CommonJS.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="nx">module</span><span class="o">?</span><span class="p">.</span><span class="nx">exports</span>
  <span class="nv">module.exports = </span><span class="nx">md</span>
<span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">define</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span> <span class="o">and</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span>
  <span class="nx">define</span> <span class="s">&#39;md&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">md</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <h2>Public constants</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Current version of html.md.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">md.version = md.VERSION = </span><span class="s">&#39;3.0.2&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <h2>Public functions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Run html.md in <em>noConflict</em> mode, returning the <code>md</code> variable to its previous owner. <br />
Returns a reference to our <code>md</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">md.noConflict = </span><span class="o">=&gt;</span>
  <span class="vi">@md = </span><span class="nx">PREVIOUS_MD</span>
  <span class="nx">md</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 